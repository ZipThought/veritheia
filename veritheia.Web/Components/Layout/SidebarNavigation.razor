@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Web
@using veritheia.Web.Services
@using Veritheia.Data.Entities
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject RenderContextService ContextService

<div class="sidebar">
    <div class="sidebar-header">
        <div class="logo">
            <span class="logo-text">VERITHEIA</span>
        </div>
    </div>

    <nav class="sidebar-nav">
        <div class="nav-section">
            <NavLink class="nav-item" href="/" Match="NavLinkMatch.All">
                <span class="nav-icon">üìä</span>
                <span class="nav-text">Dashboard</span>
            </NavLink>
        </div>

        <div class="nav-section">
            <div class="nav-section-header">
                <span class="nav-icon">üöÄ</span>
                <span class="nav-text">Journeys</span>
            </div>
            
            @if (journeys != null && journeys.Any())
            {
                <div class="nav-subsection">
                    @foreach (var journey in journeys)
                    {
                        <NavLink class="nav-subitem" href="@($"/journeys/{journey.Id}")">
                            <span class="nav-subicon">‚Ä¢</span>
                            <span class="nav-subtext">@GetTruncatedName(journey.Purpose, 10)</span>
                        </NavLink>
                    }
                </div>
            }
        </div>

        <div class="nav-section">
            <div class="nav-section-header">
                <span class="nav-icon">üë§</span>
                <span class="nav-text">Personas</span>
            </div>
            
            @if (personas != null && personas.Any())
            {
                <div class="nav-subsection">
                    @foreach (var persona in personas.Take(3))
                    {
                        <NavLink class="nav-subitem" href="@($"/personas/{persona.Id}")">
                            <span class="nav-subicon">‚Ä¢</span>
                            <span class="nav-subtext">@GetTruncatedName(persona.Domain, 20)</span>
                        </NavLink>
                    }
                    <NavLink class="nav-subitem" href="/personas/create">
                        <span class="nav-subicon">+</span>
                        <span class="nav-subtext">Create new...</span>
                    </NavLink>
                </div>
            }
            else
            {
                <div class="nav-subsection">
                    <NavLink class="nav-subitem" href="/personas/create">
                        <span class="nav-subicon">+</span>
                        <span class="nav-subtext">Create persona...</span>
                    </NavLink>
                </div>
            }
        </div>

        <div class="nav-section">
            <NavLink class="nav-item" href="/corpus">
                <span class="nav-icon">üìÑ</span>
                <span class="nav-text">Corpus</span>
            </NavLink>
        </div>

        <div class="nav-section">
            <NavLink class="nav-item" href="/settings">
                <span class="nav-icon">‚öôÔ∏è</span>
                <span class="nav-text">Settings</span>
            </NavLink>
        </div>

        <div class="nav-section">
            <NavLink class="nav-item" href="/help">
                <span class="nav-icon">‚ùì</span>
                <span class="nav-text">Help</span>
            </NavLink>
        </div>
    </nav>
</div>

@code {
    private List<JourneyViewModel>? journeys;
    private List<PersonaViewModel>? personas;
    private RenderContext? context;

    protected override void OnInitialized()
    {
        context = ContextService.GetOrCreateContext();
        context.RequireCurrentUser();
        context.RequireJourneys();
        context.RequirePersonas();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Wait for context to be initialized by MainLayout
        context = ContextService.GetOrCreateContext();
        
        // Re-declare demands on navigation (context gets reset)
        context.RequireCurrentUser();
        context.RequireJourneys();
        context.RequirePersonas();
        
        if (context?.CurrentUser == null)
        {
            // User not logged in
            return;
        }

        // Transform data to view models after context is initialized
        if (context.Journeys != null)
        {
            journeys = context.Journeys.Select(j => new JourneyViewModel 
            { 
                Id = j.Id, 
                Purpose = j.Purpose 
            }).ToList();
        }

        if (context.Personas != null)
        {
            personas = context.Personas.Select(p => new PersonaViewModel 
            { 
                Id = p.Id, 
                Domain = p.Domain 
            }).ToList();
        }
    }

    private string GetTruncatedName(string name, int maxLength)
    {
        if (string.IsNullOrEmpty(name) || name.Length <= maxLength)
            return name ?? "";
        
        return name.Substring(0, maxLength - 3) + "...";
    }

    public class JourneyViewModel
    {
        public Guid Id { get; set; }
        public string Purpose { get; set; } = "";
    }

    public class PersonaViewModel
    {
        public Guid Id { get; set; }
        public string Domain { get; set; } = "";
    }
}
